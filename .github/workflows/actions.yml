
name: Actions

on:
    push:
        branches:
            - main

permissions:
    contents: write

jobs:
    release:
        runs-on: ubuntu-latest
        environment: Testing
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            # - uses: actions/setup-node@v4
            #   with:
            #     node-version: '24'
            #     cache: "npm"

            # - name: Install Node Dependencies
            #   run: npm i

            # - name: Run ESLint
            #   run: npx eslint --fix

            # - name: Setup PHP
            #   uses: shivammathur/setup-php@v2
            #   with:
            #       php-version: 8.4
            #       tools: composer:v2
            #       coverage: xdebug

            - name: Generate changelog
              id: changelog
              run: |
                # Get the last tag
                LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

                if [ -z "$LAST_TAG" ]; then
                    # No previous tags, get all commits
                    COMMITS=$(git log --pretty=format:"- %s" | head -20)
                else
                    # Get commits since last tag
                    COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"- %s")
                fi

                # Store in output, handling multiline
                echo "commits<<EOF" >> $GITHUB_OUTPUT
                echo "$COMMITS" >> $GITHUB_OUTPUT
                echo "EOF" >> $GITHUB_OUTPUT

            - name: Bump composer version
              id: version
              run: |
                CURRENT_VERSION=$(node -p "require('./composer.json').version")
                NEXT_VERSION=$(node -e "const v = '$CURRENT_VERSION'.split('.'); v[1]++; console.log(v.join('.'))")
                composer config version $NEXT_VERSION
                VERSION=$(node -p "require('./composer.json').version")
                echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Commit version bump
              run: |
                git config user.name "${{ github.actor }}"
                git config user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
                git add composer.json
                git commit -m "chore: bump version to ${{ steps.version.outputs.version }}" || true
                git push

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                body: ${{ steps.changelog.outputs.commits }}
                draft: false
                prerelease: false
                tag_name: "${{ steps.version.outputs.version }}"
